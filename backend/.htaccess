RewriteEngine On
RewriteBase /

# --- Global CORS (Apache Level) ---
# Force CORS headers on all responses, especially OPTIONS
<IfModule mod_headers.c>
    SetEnvIf Origin "^http(s)?://(.+\.)?(bezmidar\.de|localhost)(:[0-9]+)?$" C_ORIGIN=$0
    
    Header always set Access-Control-Allow-Origin %{C_ORIGIN}e env=C_ORIGIN
    Header always set Access-Control-Allow-Credentials "true"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
</IfModule>

# Handle OPTIONS method directly to avoid PHP overhead/errors
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ - [R=204,L]

# --- Public Endpoints ---
RewriteRule ^api/check-domain/?$ api/check-domain.php [L,QSA]
RewriteRule ^api/contact/?$ api/contact.php [L,QSA]
RewriteRule ^api/packages/?$ api/packages.php [L,QSA]
RewriteRule ^api/seo/?$ api/seo.php [L,QSA]
RewriteRule ^api/test_db/?$ api/test_db.php [L,QSA]

# --- Customer Endpoints ---
# Handle /api/orders and /api/orders/{id}
RewriteRule ^api/orders/?$ api/orders.php [L,QSA]
RewriteRule ^api/orders/(.+)$ api/orders.php?route=orders/$1 [L,QSA]

# --- Auth Endpoints ---
RewriteRule ^api/auth/login/?$ api/auth/login.php [L,QSA]
RewriteRule ^api/auth/me/?$ api/auth/me.php [L,QSA]
RewriteRule ^api/auth/register/?$ api/auth/register.php [L,QSA]

# --- User Endpoints ---
RewriteRule ^api/user/orders/?$ api/user/orders.php [L,QSA]

# --- Admin Endpoints ---
RewriteRule ^api/admin/deploy/?$ api/admin/deploy.php [L,QSA]
RewriteRule ^api/admin/diagnose/?$ api/admin/diagnose.php [L,QSA]
RewriteRule ^api/admin/login/?$ api/admin/login.php [L,QSA]
RewriteRule ^api/admin/messages/?$ api/admin/messages.php [L,QSA]
RewriteRule ^api/admin/packages/?$ api/admin/packages.php [L,QSA]
RewriteRule ^api/admin/seo/?$ api/admin/seo.php [L,QSA]
RewriteRule ^api/admin/settings/?$ api/admin/settings.php [L,QSA]
RewriteRule ^api/admin/stats/?$ api/admin/stats.php [L,QSA]
RewriteRule ^api/admin/unmatched/?$ api/admin/unmatched.php [L,QSA]

# Handle /api/admin/orders and /api/admin/orders/{id}
RewriteRule ^api/admin/orders/?$ api/admin/orders.php [L,QSA]
RewriteRule ^api/admin/orders/(.+)$ api/admin/orders.php?route=admin/orders/$1 [L,QSA]

# Fallback for anything else in /api (optional, but good for safety)
# RewriteCond %{DOCUMENT_ROOT}/api/$1.php -f
# RewriteRule ^api/(.*)$ api/$1.php [L]

# Route everything else to index.php (optional, for 404s or root)
RewriteRule ^$ index.php [L]

# Security
<FilesMatch "\.(env|config\.php|sql|log)$">
    Order allow,deny
    Deny from all
</FilesMatch>
